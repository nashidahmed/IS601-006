{% extends "layout.html" %} {% block title %}Cart{% endblock %}

<!-- content -->
{% block content %}
<div class="container-fluid medium">
  <div class="h2 text-center mt-3 mb-4">Cart</div>
  {% if rows and rows|length > 0 %}
  <form method="POST" class="text-end my-3" action="{{url_for('cart.clear')}}">
    <input type="submit" class="btn btn-primary" value="Clear cart" />
  </form>
  <table class="table">
    <thead>
      <tr>
        <th>Product</th>
        <th>Unit price</th>
        <th>Quantity</th>
        <th>Subtotal</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% set ns = namespace(cart_total=0, actual_total=0) %} {% for row in rows %}
      <tr>
        <td class="d-flex align-items-center">
          <div class="cart-image">
            {% if row.image %}
            <img src="{{row.image}}" alt="{{row.name}}" />
            {% else %}
            <img src="/static/images/no-image.jpg" alt="no image available" />
            {% endif %}
          </div>
          <h5 class="ms-3">{{row.name}}</h5>
        </td>
        <td>
          {% if row.product_cost != row.cart_cost %}
          ${{'%.2f' % (row.product_cost / 100)|float}}
          ({% if row.product_cost - row.cart_cost > 0 %}+{% else %}-{% endif %}
          {{ '%.2f' % ((row.product_cost - row.cart_cost) / row.cart_cost * 100) | float |abs }}%)
          <div class="strikethrough">
            ${{'%.2f' % (row.cart_cost / 100)|float}}
          </div>
          {% else %}
          ${{'%.2f' % (row.product_cost / 100)|float}}
          {% endif %}
        </td>
        <td style="width: 15rem">
          <form method="POST" action="{{url_for('cart.update')}}">
            <div class="row">
              <input type="hidden" name="product_id" value="{{row.product_id}}" />
              <div class="col">
                <input type="number" class="form-control" name="quantity" value="{{row.quantity}}" />
              </div>
              <div class="col d-grid">
                <input type="submit" value="Update" class="btn btn-secondary btn-sm" />
              </div>
            </div>
          </form>
        </td>
        <td>
          {% if row.cart_subtotal != row.actual_subtotal %}
          {% set actual_price = row.actual_subtotal / 100 %}
          ${{'%.2f' % actual_price|float}}
          ({% if row.actual_subtotal - row.cart_subtotal > 0 %}+{% else %}-{% endif %}
          {{ '%.2f' % ((row.actual_subtotal - row.cart_subtotal) / row.cart_subtotal * 100) | float |abs }}%)
          <div class="strikethrough">
            ${{'%.2f' % (row.cart_subtotal / 100)|float}}
          </div>
          {% else %}
          {% set price = row.cart_subtotal / 100 %}
          ${{'%.2f' % price|float}}
          {% endif %}
        </td>
        <td>
          <form method="POST" action="{{url_for('cart.delete')}}">
            <input type="hidden" name="product_id" value="{{row.product_id}}" />
            <input type="hidden" name="name" value="{{row.name}}" />
            <input type="hidden" name="quantity" value="-1" />
            <a href="{{url_for('shop.view', id=row.product_id)}}" class="btn btn-primary btn-sm">View</a>
            <input type="submit" value="x" class="btn btn-danger btn-sm" />
          </form>
        </td>
        {% set ns.cart_total = ns.cart_total + row.cart_subtotal %}
        {% set ns.actual_total = ns.actual_total + row.actual_subtotal %}
      </tr>
      {% endfor %}
      <tr>
        <td></td>
        <td colspan="2" class="text-end fw-bold">Total: </td>
        <td colspan="2">
          {% if ns.cart_total != ns.actual_total %}
          {% set actual_price = ns.actual_total / 100 %}
          ${{'%.2f' % actual_price|float}}
          ({% if ns.actual_total - ns.cart_total > 0 %}+{% else %}-{% endif %}
          {{ '%.2f' % ((ns.actual_total - ns.cart_total) / ns.cart_total * 100) | float |abs }}%)
          <div class="strikethrough">
            ${{'%.2f' % (ns.cart_total / 100)|float}}
          </div>
          {% else %}
          {% set price = ns.cart_total / 100 %}
          ${{'%.2f' % price|float}}
          {% endif %}
        </td>
      </tr>
    </tbody>
  </table>
  <div class="text-center">
    <a href="{{url_for('orders.view')}}" class="btn btn-primary">Checkout</a>
  </div>
  {% else %}
  <div class="text-center" colspan="100%">
    <h5 class="mt-5">
      No items in cart
      <br />
      <br />
      <a href="{{url_for('shop.view_all')}}" class="btn btn-primary">View products</a>
    </h5>
  </div>
  {% endif %}
</div>
{% endblock %}